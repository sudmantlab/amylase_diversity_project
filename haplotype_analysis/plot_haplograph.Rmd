---
title: "Untitled"
output: html_document
date: "2022-08-12"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
library(tidyverse)
#library(ggforce)
library(ggsankey)
library(PNWColors)

pop_info = read.table("/Users/petersudmant/Documents/science/sudmantlab/projects/ancient_DNA/amylase/haplotype_analysis/metadata/modern_and_ancient_european.tsv",header=T,sep="\t") %>% 
    mutate(popGrouping = ifelse(popGrouping %in% c("CEU","TSI","GBR","FIN","IBS"),
                                "modern European",
                                paste("ancient ",popGrouping,sep=""))) %>%
    mutate(popGrouping = ifelse(grepl("Hunter",popGrouping),"ancient Hunter-Gatherer",popGrouping))

pop_info = read.table("/Users/petersudmant/Documents/science/sudmantlab/projects/ancient_DNA/amylase/haplotype_analysis/metadata/1000_genomes_simple_EASTASIA.tsv",header=T,sep="\t") %>%
  mutate(popGrouping=POPULATION)

EAST_ASIA = c("CHB","JPT","CHS","CDX","KHV","CHD")
EUROPE = c("CEU","TSI","GBR","FIN","IBS")
AFRICA = c("YRI","LWK","GWD","MSL","ESN")
ADMIXED = c("ASW","ACB","MXL","PUR","CLM","PEL")
SOUTH_ASIA = c("GIH","PJL","BEB","STU","ITU")

pop_info = read.table("/Users/petersudmant/Documents/science/sudmantlab/projects/ancient_DNA/amylase/haplotype_analysis/metadata/1000_genomes_simple.tsv",header=T,sep="\t") %>%
  mutate(popGrouping=POPULATION) %>%
  mutate(popGrouping =
           case_when(
              popGrouping %in% EAST_ASIA ~ "EAST_ASIA",
              popGrouping %in% EUROPE ~ "EUROPE",
              popGrouping %in% AFRICA ~ "AFRICA",
              popGrouping %in% ADMIXED ~ "ADMIXED",
              popGrouping %in% SOUTH_ASIA ~ "SOUTH_ASIA",
              popGrouping %in% TRUE ~ "---"))
  

pop_info = read.table("/Users/petersudmant/Documents/science/sudmantlab/projects/ancient_DNA/amylase/haplotype_analysis/metadata/1000_genomes_simple_ALL_plus_ancient.tsv",header=T,sep="\t") %>%
  mutate(popGrouping =
           case_when(
              popGrouping %in% EAST_ASIA ~ "modern-EAST_ASIA",
              popGrouping %in% EUROPE ~ "modern-EUROPE",
              popGrouping %in% AFRICA ~ "modern-AFRICA",
              popGrouping %in% ADMIXED ~ "modern-ADMIXED",
              popGrouping %in% SOUTH_ASIA ~ "modern-SOUTH_ASIA",
              TRUE ~ paste("ancient",popGrouping,sep="-")))

#write.table(pop_info,"/Users/petersudmant/Documents/science/sudmantlab/projects/ancient_DNA/amylase/haplotype_analysis/metadata/modernALL_ancientEuro_relabled.tsv",sep="\t",row.names = FALSE,quote = FALSE)
```



```{r}


#t = read.table("/Users/petersudmant/Documents/science/sudmantlab/projects/ancient_DNA/amylase/haplotype_analysis/output/AMY_100000_EUROPEAN.tsv",sep="\t",header=TRUE)
#t = read.table("/Users/petersudmant/Documents/science/sudmantlab/projects/ancient_DNA/amylase/haplotype_analysis/output/AMY_100000_modern-ancient-EUR.tsv",sep="\t",header=TRUE)
#t = read.table("/Users/petersudmant/Documents/science/sudmantlab/projects/ancient_DNA/amylase/haplotype_analysis/output/AMY_100000_EASTASIA.tsv",sep="\t",header=TRUE)
#fn_out = paste(outdir,"/100kb_modern_ancient_euro_AMY_samples_colored_paths.png",sep="")

t = read.table("/Users/petersudmant/Documents/science/sudmantlab/projects/ancient_DNA/amylase/haplotype_analysis/output/AMY_100000_EASTASIA.tsv",sep="\t",header=TRUE)
fn_out = paste(outdir,"/100kb_modern_ASIA_AMY_samples_colored_paths.png",sep="")

#t = read.table("/Users/petersudmant/Documents/science/sudmantlab/projects/ancient_DNA/amylase/haplotype_analysis/output/AMY_100000_modern.tsv",sep="\t",header=TRUE)
#fn_out = paste(outdir,"/100kb_modern_ALL_AMY_samples_colored_paths.png",sep="")

t = read.table("/Users/petersudmant/Documents/science/sudmantlab/projects/ancient_DNA/amylase/haplotype_analysis/output/AMY_100000_modern-ancient-EUR.tsv",sep="\t",header=TRUE)
fn_out = paste(outdir,"/100kb_modern_EUROPE_AMY_samples_w_ancients_colored_paths.png",sep="")
colors =pnw_palette("Bay",5)

t = read.table("/Users/petersudmant/Documents/science/sudmantlab/projects/ancient_DNA/amylase/haplotype_analysis/output/AMY_100000_modern-ancient.tsv",sep="\t",header=TRUE)
fn_out = paste(outdir,"/100kb_modern_ALL_AMY_samples_w_ancients_colored_paths.png",sep="")
colors =pnw_palette("Bay",8)

t = read.table("/Users/petersudmant/Documents/science/sudmantlab/projects/ancient_DNA/amylase/haplotype_analysis/output/AMY_50000_modern-ancient.tsv",sep="\t",header=TRUE)
fn_out = paste(outdir,"/50kb_modern_ALL_AMY_samples_w_ancients_colored_paths.png",sep="")
fn_out_2 = paste(outdir,"/50kb_modern_ALL_AMY_samples_w_ancients_haploslice.png",sep="")
colors =pnw_palette("Bay",8)


#colors =pnw_palette("Bay",9)[c(5,3,1,7,9)]
#colors =pnw_palette("Bay",9)[c(5,1,7,9)]



space=100
t_node = t %>% group_by(position,node,dir) %>%
  #dplyr::group_by_all() %>%
  dplyr::summarise(freq = dplyr::n(), .groups="keep") %>%
  ungroup() %>%
  group_by(position,dir) %>%
  dplyr::mutate(ymax = cumsum(freq) + (dplyr::row_number() - 1)*space,
                ymin = ymax - freq) %>%
  dplyr::mutate(ymin = ymin - max(ymax)/2,
                ymax = ymax - max(ymax)/2) %>%
  dplyr::ungroup()

t_indiv_paths = inner_join(t,t_node,by=c("position","node","dir")) %>%
                group_by(position,node) %>%
                mutate(path_y = ymin+row_number()) %>%
                inner_join(pop_info,on="sample")

#g+geom_segment(aes(x=position,xend=position,y=ymin,yend=ymax),data=t_node)+


g=ggplot(t_indiv_paths %>% mutate(dir=ifelse(dir=="left","distal","proximal")))
g=g+geom_segment(aes(x=position,xend=next_pos,y=path_y,yend=path_y,color=popGrouping),
               size=.01,
               alpha=1)+
  #scale_color_viridis_d()+
  theme_bw(base_size=8)+
  guides(color=guide_legend(override.aes = list(size=1)))+
  theme(panel.grid = element_blank())+
  facet_grid(.~dir,scales="free_x")+
  scale_color_manual(values=colors)+
  theme(strip.background=element_blank(),
        panel.border = element_blank(),
        legend.key.size = unit(.1,"cm"))+
  geom_vline(aes(xintercept = x),
             data=data.frame(x=104327640,dir="proximal"),
             linetype="dotted",
             alpha=0.5)
  
  
outdir="/Users/petersudmant/Documents/science/sudmantlab/projects/ancient_DNA/amylase/haplotype_analysis/output"
#fn_out = paste(outdir,"/100kb_modern_ancient_euro_AMY_samples_colored_paths.png",sep="")
png(fn_out,width=6.5,height=3,units='in',res=600)
print(g)
dev.off()


node_props = t_indiv_paths %>% 
  ungroup() %>%
  filter(position==104327640) %>%
  mutate(total_haps = n()) %>%
  group_by(popGrouping) %>%
  mutate(total_n_of_pop = n()) %>%
  ungroup() %>%
  group_by(node,total_haps,total_n_of_pop) %>%
  mutate(node=node,node_size=n()) %>%
  group_by(popGrouping,node_size,node,total_haps,total_n_of_pop) %>%
  summarize(n_pop = n()) %>%
  mutate(pop_prop_of_node = n_pop/node_size,
         node_prop_of_total = node_size/total_haps) %>%
  mutate(node_prop_of_pop=n_pop/total_n_of_pop) #%>%
  #filter(node_prop_of_total>0.01)

# g=ggplot(node_props)
# g+geom_bar(aes(x=factor(node),y=pop_prop_of_node,fill=popGrouping),stat='identity')+
#   theme_bw()+
#   scale_fill_manual(values=colors)

# ex = node_props %>% 
#   dplyr::select(popGrouping,node,node_size) %>% 
#   unique()

cutoff = 0.05

t_plot_gt = node_props %>% 
  filter(node_prop_of_pop>=cutoff) %>%
  dplyr::select(popGrouping,node,node_prop_of_pop) %>%
  mutate(node = as.character(node))

t_plot_lt = node_props %>% 
  filter(node_prop_of_pop<cutoff) %>%
  group_by(popGrouping) %>%
  summarize(node_prop_of_pop=sum(node_prop_of_pop)) %>%
  mutate(node=paste("<",cutoff*100,"%")) %>%
  dplyr::select(popGrouping,node,node_prop_of_pop)

t_plot = rbind(t_plot_gt,t_plot_lt)

colors = c("grey",pnw_palette("Sailboat",7))

pop_order = c("modern-AFRICA",
              "modern-EAST_ASIA",
              "modern-SOUTH_ASIA",          
              "modern-EUROPE",
              "ancient-Yamnaya",
              "ancient-Early Farmer",
              "ancient-Hunter-Gatherer (E)",
              "ancient-Hunter-Gatherer (W)")
              
t_plot$popGrouping = factor(t_plot$popGrouping,levels = pop_order)



g=ggplot(t_plot )
g=g+geom_bar(aes(x=popGrouping,y=node_prop_of_pop,fill=node),stat='identity')+
  theme_bw()+
  scale_fill_viridis_d("Haplotype Node")+
  coord_flip()
  #scale_fill_manual(values=colors)

outdir="/Users/petersudmant/Documents/science/sudmantlab/projects/ancient_DNA/amylase/haplotype_analysis/output"
png(fn_out_2,width=5,height=3,units='in',res=600)
print(g)
dev.off()


```
```{r}
### OLD GEOM SANKEY APPROACH

```

```{r}

t = read.table("/Users/petersudmant/Documents/science/sudmantlab/projects/ancient_DNA/amylase/haplotype_analysis/output/LCT_100000_modern-ancient-EUR.tsv",sep="\t",header=TRUE)

  g=ggplot(t) +
  geom_sankey(aes(x = position, 
                  next_x = next_pos,
                  node = node, 
                  next_node = next_node),
              alpha=0.5,
              space=50,
              smooth=8) +
  facet_grid(.~dir,scales="free")+
  theme_alluvial(base_size = 4)+
  theme(axis.text.y=element_blank())+
  theme(legend.position="None")

outdir="/Users/petersudmant/Documents/science/sudmantlab/projects/ancient_DNA/amylase/haplotype_analysis/output"
fn_out = paste(outdir,"/100kb_modern_ancient_euro_LCT_samples.pdf",sep="")
pdf(fn_out,width=3.5,height=3)
print(g)
dev.off()

#t %>% group_by(node,position,next_node,next_pos) %>%
#  summarize(sum = n())
# df <- gapminder %>%
#   group_by(continent, year) %>%
#   summarise(gdp = (sum(pop * gdpPercap)/1e9) %>% round(0), .groups = "keep") %>%
#   ungroup()



space=50
t_node = t %>% group_by(position,node,dir) %>%
  #dplyr::group_by_all() %>%
  dplyr::summarise(freq = dplyr::n(), .groups="keep") %>%
  ungroup() %>%
  group_by(position,dir) %>%
  dplyr::mutate(ymax = cumsum(freq) + (dplyr::row_number() - 1)*space,
                ymin = ymax - freq) %>%
  dplyr::mutate(ymin = ymin - max(ymax)/2,
                ymax = ymax - max(ymax)/2) %>%
  dplyr::ungroup()

t_indiv_paths = inner_join(t,t_node,by=c("position","node","dir")) %>%
                group_by(position,node) %>%
                mutate(path_y = ymin+row_number()) %>%
                inner_join(pop_info,on="sample")

#g+geom_segment(aes(x=position,xend=position,y=ymin,yend=ymax),data=t_node)+
  
g=ggplot(t_indiv_paths)
g=g+geom_segment(aes(x=position,xend=next_pos,y=path_y,yend=path_y,color=popGrouping),
               size=.01,
               alpha=1)+
  scale_color_manual(values=colors)+
  theme_bw()+
  guides(color=guide_legend(override.aes = list(size=1)))+
  theme(panel.grid = element_blank())+
  theme(legend.key.size=unit(0.25,"cm"))
print(g)  
outdir="/Users/petersudmant/Documents/science/sudmantlab/projects/ancient_DNA/amylase/haplotype_analysis/output"
fn_out = paste(outdir,"/100kb_modern_ancient_euro_LCT_samples_colored_paths.png",sep="")
png(fn_out,width=6.5,height=3,units='in',res=600)
print(g)
dev.off()

```

```{r}

t %>% filter(is.na(next_pos)) %>%
  group_by(node,position,dir) %>%
  summarize(sum = n()) %>%
  arrange(sum)#%>%
  #filter(sum>1000)
  #group_by(node,position,next_node,next_pos,sample,dir) 


#unique(t$sample)[1000:2000]

```


```{r}
data

df = data.frame(x=c(0,10,10),
           y=c(0,0,1),
           id=c(1,2,3),
           value=c(1,0.6,0.4))

ggplot(df, aes(x, id = id, split = y, value = value)) +
  geom_parallel_sets(alpha = 1, axis.width = 0.1)
  #geom_parallel_sets_axes(axis.width = 0.1) +
  #geom_parallel_sets_labels(colour = 'white')

```